name: CI

on:
  push:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.claude/**'
      - '.mcp.json'
      - '_template/**'
      - 'lint/**'
      - 'Makefile'
      - 'scripts/**'
      - '.github/workflows/ci.yml'
      - '.goreleaser.yaml'
  pull_request:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.claude/**'
      - '.mcp.json'
      - '_template/**'
      - 'lint/**'
      - 'Makefile'
      - 'scripts/**'
      - '.github/workflows/ci.yml'
      - '.goreleaser.yaml'

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Setup CUE
        uses: cue-lang/setup-cue@v1.0.1
        with:
          version: 'latest'

      - name: Setup golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v2.10
          args: --disable gocyclo ./...

      - name: Lint templates
        if: always()
        run: make lint

      - name: Vet
        run: go vet ./...

      - name: Test
        run: bash scripts/ci-run-tests.sh /tmp/test-output.json

      - name: Job Summary
        if: always()
        run: bash scripts/ci-test-summary.sh /tmp/test-output.json "${{ matrix.os }}"

      - name: Build
        run: go build -o claude-workspace .

  cross-compile:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "0"
        run: go build -o /dev/null .

      - name: Job Summary
        if: always()
        run: |
          echo "## Cross-compile \`${{ matrix.goos }}/${{ matrix.goarch }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo ':white_check_mark: Build succeeded' >> "$GITHUB_STEP_SUMMARY"

  smoke-test:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Smoke test (Docker)
        run: make smoke-test-docker

  pre-release:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    needs: [build, cross-compile, smoke-test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute pre-release version
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)

          # Get the latest stable tag, default to v0.0.0
          LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | grep -v '-' | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi

          # Count commits since the last stable tag
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            COMMITS_SINCE=$(git rev-list "${LATEST_TAG}..HEAD" --count)
          else
            COMMITS_SINCE=$(git rev-list HEAD --count)
          fi

          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          NEXT_PATCH=$((PATCH + 1))

          TAG="v${MAJOR}.${MINOR}.${NEXT_PATCH}-alpha.${COMMITS_SINCE}.${SHORT_SHA}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Pre-release tag: ${TAG}"

      - name: Create and push tag
        run: |
          git tag "${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job Summary
        if: always()
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          echo "## Pre-release \`${TAG}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| | |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Tag** | \`${TAG}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Commit** | \`${{ github.sha }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Release** | [View on GitHub](https://github.com/${{ github.repository }}/releases/tag/${TAG}) |" >> "$GITHUB_STEP_SUMMARY"
