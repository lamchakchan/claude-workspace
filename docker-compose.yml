# Claude Code Platform - Docker Compose
#
# Quick start:
#   docker compose run --rm claude
#
# With a specific project:
#   PROJECT_DIR=/path/to/project docker compose run --rm claude
#
# Multiple parallel agents (sandboxed branches):
#   docker compose run --rm -e BRANCH=feature-auth claude
#   docker compose run --rm -e BRANCH=feature-api claude

services:
  claude:
    build:
      context: .
      dockerfile: Dockerfile
    stdin_open: true
    tty: true
    environment:
      # API key provisioning (Option 2: self-provision)
      # Set this in .env file or pass via -e flag
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

      # Model defaults
      - CLAUDE_CODE_SUBAGENT_MODEL=sonnet
      - CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1
      - CLAUDE_AUTOCOMPACT_PCT_OVERRIDE=80

      # Optional: branch for sandboxed parallel work
      - BRANCH=${BRANCH:-}
    volumes:
      # Mount your project into the container
      - ${PROJECT_DIR:-.}:/workspace

      # Persist Claude auth and session data between runs
      - claude-auth:/root/.claude
      - claude-config:/root/.claude.json

      # Mount SSH keys for git operations (read-only)
      - ${HOME}/.ssh:/root/.ssh:ro

      # Mount git config (read-only)
      - ${HOME}/.gitconfig:/root/.gitconfig:ro

  # Agent team member - use for parallel work
  # docker compose run --rm agent "implement the auth module"
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    stdin_open: true
    tty: true
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CODE_SUBAGENT_MODEL=sonnet
    volumes:
      - ${PROJECT_DIR:-.}:/workspace
      - claude-auth:/root/.claude
      - claude-config:/root/.claude.json
      - ${HOME}/.ssh:/root/.ssh:ro
      - ${HOME}/.gitconfig:/root/.gitconfig:ro
    entrypoint: ["/usr/local/bin/entrypoint.sh"]
    command: ["claude", "--print", "$@"]
    profiles:
      - agent

volumes:
  claude-auth:
    name: claude-platform-auth
  claude-config:
    name: claude-platform-config
